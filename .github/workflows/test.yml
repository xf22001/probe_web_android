# Workflow 名称
name: test

# 触发器配置：改为手动触发
on:
  workflow_dispatch:
    # (可选) 为手动触发添加输入参数
    # 你可以在 Actions 页面运行时填写这些参数
    inputs:
      log_level:
        description: 'Gradle log level'
        required: true
        default: 'info' # 默认日志级别
        type: choice
        options:
          - info
          - debug

jobs:
  # Job ID，可以自定义
  build-android-app:
    # Job 名称，会显示在 GitHub UI 中
    name: Build Android Application with Go AAR

    # 运行此 Job 的虚拟机环境
    runs-on: ubuntu-latest

    # Job 的执行步骤
    steps:
      # 步骤 1: 检出代码
      # 使用 actions/checkout@v4 版本
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Android APK 编译相关步骤 ---

      # 步骤 1: 授予 gradlew 执行权限
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Decode Keystore and Set Signing Environment Variables
        # 仅当 ANDROID_SIGNING_COMBINED_SECRET 存在时才执行此步骤
        # #if: ${{ secrets.ANDROID_SIGNING_COMBINED_SECRET != '' }}
        run: |
          # 解析合并的秘密字符串
          SIGNING_INFO="${{ secrets.ANDROID_SIGNING_COMBINED_SECRET }}"
          KEYSTORE_BASE64=$(echo "$SIGNING_INFO" | cut -d'|' -f1)
          KEYSTORE_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f2)
          KEY_ALIAS=$(echo "$SIGNING_INFO" | cut -d'|' -f3)
          KEY_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f4)
          
          # 检查是否成功解析所有部分
          if [ -z "$KEYSTORE_BASE64" ] || [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
            echo "Error: Failed to parse ANDROID_SIGNING_COMBINED_SECRET. One or more parts are empty."
            exit 1
          fi
          
          # 将 Base64 编码的密钥库解码并保存到 app/ 目录下
          echo "$KEYSTORE_BASE64" | base64 --decode

          echo "$KEYSTORE_PASSWORD"
          echo "$KEY_ALIAS"
          echo "$KEY_PASSWORD"
        shell: bash # 明确指定 bash shell，以便正确处理管道和环境变量
