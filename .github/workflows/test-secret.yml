name: Test Combined Signing Secret

on:
  # 允许手动触发此工作流
  workflow_dispatch:

jobs:
  test-secret-parsing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check and Parse Combined Signing Secret
        # 仅当 ANDROID_SIGNING_COMBINED_SECRET 存在时才执行此步骤
        if: secrets.ANDROID_SIGNING_COMBINED_SECRET != ''
        run: |
          echo "Combined Signing Secret found. Attempting to parse..."

          # 获取合并的秘密字符串
          SIGNING_INFO="${{ secrets.ANDROID_SIGNING_COMBINED_SECRET }}"

          # 使用 cut 命令解析各个部分
          KEYSTORE_BASE64=$(echo "$SIGNING_INFO" | cut -d'|' -f1)
          KEYSTORE_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f2)
          KEY_ALIAS=$(echo "$SIGNING_INFO" | cut -d'|' -f3)
          KEY_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f4)

          # 打印解析结果 (注意：为了安全，不打印完整密码和Base64内容)
          echo "--- Parsed Components ---"
          echo "KEYSTORE_BASE64 (first 20 chars): ${KEYSTORE_BASE64:0:20}..."
          echo "KEYSTORE_PASSWORD (length): ${#KEYSTORE_PASSWORD}" # 打印长度以确认非空
          echo "KEY_ALIAS: $KEY_ALIAS"
          echo "KEY_PASSWORD (length): ${#KEY_PASSWORD}" # 打印长度以确认非空
          echo "-------------------------"

          # 检查是否成功解析所有部分
          if [ -z "$KEYSTORE_BASE64" ] || [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
            echo "Error: Failed to parse ANDROID_SIGNING_COMBINED_SECRET. One or more parts are empty."
            exit 1
          fi

          # 将解析出的组件设置为环境变量，供后续步骤使用
          echo "SIGNING_KEYSTORE_FILE_DUMMY_PATH=/tmp/test.jks" >> $GITHUB_ENV # 文件路径在测试中不重要，但需要一个值
          echo "SIGNING_KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
          echo "SIGNING_KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV

          echo "Environment variables set for next step."
        shell: bash

      - name: Verify Environment Variables from GITHUB_ENV
        # 这个步骤会检查前一个步骤设置的环境变量是否成功传递
        run: |
          echo "--- Verifying GITHUB_ENV variables ---"
          echo "SIGNING_KEYSTORE_FILE_DUMMY_PATH: ${{ env.SIGNING_KEYSTORE_FILE_DUMMY_PATH }}"
          echo "SIGNING_KEYSTORE_PASSWORD (length): ${#SIGNING_KEYSTORE_PASSWORD}" # 从 env 读取并获取长度
          echo "SIGNING_KEY_ALIAS: ${{ env.SIGNING_KEY_ALIAS }}"
          echo "SIGNING_KEY_PASSWORD (length): ${#SIGNING_KEY_PASSWORD}" # 从 env 读取并获取长度
          echo "--------------------------------------"

          if [ -z "${{ env.SIGNING_KEYSTORE_PASSWORD }}" ] || [ -z "${{ env.SIGNING_KEY_ALIAS }}" ] || [ -z "${{ env.SIGNING_KEY_PASSWORD }}" ]; then
            echo "Error: One or more environment variables are empty after setting GITHUB_ENV."
            exit 1
          fi
        shell: bash
