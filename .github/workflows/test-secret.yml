name: Test Combined Signing Secret

on:
  workflow_dispatch:

jobs:
  test-secret-parsing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check and Parse Combined Signing Secret
        if: github.secrets.ANDROID_SIGNING_COMBINED_SECRET != ''
        run: |
          echo "Combined Signing Secret found. Attempting to parse..."

          SIGNING_INFO="${{ secrets.ANDROID_SIGNING_COMBINED_SECRET }}"

          KEYSTORE_BASE64=$(echo "$SIGNING_INFO" | cut -d'|' -f1)
          KEYSTORE_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f2)
          KEY_ALIAS=$(echo "$SIGNING_INFO" | cut -d'|' -f3)
          KEY_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f4)

          echo "--- Parsed Components ---"
          echo "KEYSTORE_BASE64 (first 20 chars): ${KEYSTORE_BASE64:0:20}..."
          echo "KEYSTORE_PASSWORD (length): ${#KEYSTORE_PASSWORD}"
          echo "KEY_ALIAS: $KEY_ALIAS"
          echo "KEY_PASSWORD (length): ${#KEY_PASSWORD}"
          echo "-------------------------"

          if [ -z "$KEYSTORE_BASE64" ] || [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
            echo "Error: Failed to parse ANDROID_SIGNING_COMBINED_SECRET. One or more parts are empty."
            exit 1
          fi

          echo "SIGNING_KEYSTORE_FILE_DUMMY_PATH=/tmp/test.jks" >> $GITHUB_ENV
          echo "SIGNING_KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
          echo "SIGNING_KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV

          echo "Environment variables set for next step."
        shell: bash

      - name: Verify Environment Variables from GITHUB_ENV
        run: |
          echo "--- Verifying GITHUB_ENV variables ---"
          # 修复：直接使用 shell 变量语法访问由 GITHUB_ENV 设置的变量
          echo "SIGNING_KEYSTORE_FILE_DUMMY_PATH: $SIGNING_KEYSTORE_FILE_DUMMY_PATH"
          echo "SIGNING_KEYSTORE_PASSWORD (length): ${#SIGNING_KEYSTORE_PASSWORD}"
          echo "SIGNING_KEY_ALIAS: $SIGNING_KEY_ALIAS"
          echo "SIGNING_KEY_PASSWORD (length): ${#SIGNING_KEY_PASSWORD}"
          echo "--------------------------------------"

          # 修复：直接使用 shell 变量语法进行检查
          if [ -z "$SIGNING_KEYSTORE_PASSWORD" ] || [ -z "$SIGNING_KEY_ALIAS" ] || [ -z "$SIGNING_KEY_PASSWORD" ]; then
            echo "Error: One or more environment variables are empty after setting GITHUB_ENV."
            exit 1
          fi
        shell: bash
