name: Manual Android CI Build with Go AAR

on:
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Gradle log level'
        required: true
        default: 'info'
        type: choice
        options:
          - info
          - debug

jobs:
  build-android-app:
    name: Build Android Application with Go AAR

    runs-on: ubuntu-latest

    steps:
      # 步骤 1: 检出当前仓库代码
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          path: main-repo # 检出到名为 main-repo 的子目录

      # 步骤 2: 设置 Java 环境
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      # --- Go AAR 编译相关步骤 ---

      # 步骤 3: 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # 步骤 4: 设置 Android SDK 和 NDK
      - name: Setup Android SDK & NDK
        run: |
          # 确保 ANDROID_HOME 在当前 shell 会话中可用
          export ANDROID_HOME=/usr/local/lib/android/sdk
          # 将 ANDROID_HOME 设置为环境变量，供后续步骤使用
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          
          # 将 Android SDK 命令行工具添加到 PATH，以便 sdkmanager 命令在当前 shell 会话中可用
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          # 将此 PATH 修改添加到环境变量，供后续步骤使用
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          
          # 安装指定版本的 NDK
          yes | sdkmanager "ndk;25.2.9519653" "platform-tools" "build-tools;34.0.0"
          
          # 设置 ANDROID_NDK_HOME 环境变量供 gomobile 使用，并在当前 shell 会话中可用
          export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

      # 步骤 5: 安装 gomobile tools
      - name: Install gomobile tools
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      # 步骤 6: 初始化 gomobile 环境
      - name: Initialize gomobile
        run: gomobile init
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # 步骤 7: 检出 Go 核心库仓库并复制 `lib` 目录
      - name: Checkout Go core library and copy 'lib' directory
        run: |
          # 检出外部 Go 核心库仓库到临时目录
          git clone https://github.com/xf22001/probe_web.git temp_go_core_repo
          
          # 切换到主仓库根目录
          cd main-repo
          
          # 确保 lib 目录存在，如果存在则清理，再创建
          rm -rf lib
          mkdir lib
          
          # 从临时仓库复制 lib 目录的内容到当前仓库的 lib 目录
          cp -R ../temp_go_core_repo/lib/* lib/
          
          # (可选) 打印 lib 目录内容以验证
          echo "Contents of main-repo/lib after copy:"
          ls -l lib/
        # 注意：这里不需要设置 GITHUB_TOKEN，因为 xf22001/probe_web 是公开的。

      # 步骤 8: 配置 Go 模块并下载依赖
      - name: Configure Go Module and Download Dependencies
        working-directory: ./main-repo # 在主仓库目录下执行
        run: |
          if [ ! -f go.mod ]; then
            go mod init probetool # 假设您的模块名是 probetool
          fi
          go mod tidy # 下载所有依赖
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # 步骤 9: 编译 Go AAR
      - name: Build Go AAR
        working-directory: ./main-repo # 在主仓库目录下执行
        run: |
          # 使用正确的 -javapkg 选项
          gomobile bind -target=android -androidapi 24 -o probetool.aar -javapkg "com.xiaofei.probetool.lib.probetool" .
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # 步骤 10: 拷贝生成的 AAR 到 Android 应用的 libs 目录
      - name: Copy AAR to Android app libs
        working-directory: ./main-repo # 在主仓库目录下执行
        run: |
          mkdir -p ./app/libs
          cp ./probetool.aar ./app/libs/probetool.aar

      # 步骤 11: 上传生成的 probetool.aar 作为 artifact
      - name: Upload Go AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: probetool-aar
          path: ./main-repo/probetool.aar
          retention-days: 7

      # --- Android APK 编译相关步骤 ---

      # 步骤 12: 授予 gradlew 执行权限
      - name: Grant execute permission for gradlew
        working-directory: ./main-repo
        run: chmod +x ./gradlew

      # 13: 解码 Keystore 并设置签名环境变量
      - name: Decode Keystore and Set Signing Environment Variables
        if: secrets.ANDROID_SIGNING_COMBINED_SECRET != ''
        working-directory: ./main-repo
        run: |
          SIGNING_INFO="${{ secrets.ANDROID_SIGNING_COMBINED_SECRET }}"
          KEYSTORE_BASE64=$(echo "$SIGNING_INFO" | cut -d'|' -f1)
          KEYSTORE_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f2)
          KEY_ALIAS=$(echo "$SIGNING_INFO" | cut -d'|' -f3)
          KEY_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f4)
          
          if [ -z "$KEYSTORE_BASE64" ] || [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
            echo "Error: Failed to parse ANDROID_SIGNING_COMBINED_SECRET. One or more parts are empty."
            exit 1
          fi
          
          echo "$KEYSTORE_BASE64" | base64 --decode > app/release.jks

          echo "SIGNING_KEYSTORE_FILE=$(pwd)/app/release.jks" >> $GITHUB_ENV
          echo "SIGNING_KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
          echo "SIGNING_KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
        shell: bash
        
      # 步骤 14: 运行 Gradle 构建，生成 debug APK
      - name: Build debug APK with Gradle
        working-directory: ./main-repo
        run: ./gradlew assembleDebug --${{ github.event.inputs.log_level }}

      # 步骤 15: 上传构建产物 (Debug APK)
      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: ./main-repo/app/build/outputs/apk/debug/*.apk
          retention-days: 7

      # 步骤 16: 运行 Gradle 构建，生成 release APK
      - name: Build release APK with Gradle
        working-directory: ./main-repo
        if: secrets.ANDROID_SIGNING_COMBINED_SECRET != ''
        run: ./gradlew assembleRelease --${{ inputs.log_level }}

      # 步骤 17: 上传构建产物 (Release APK)
      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ./main-repo/app/build/outputs/apk/release/*.apk
          retention-days: 7
