# Workflow 名称
name: Manual Android CI Build with Go AAR

# 触发器配置：改为手动触发
on:
  workflow_dispatch:
    # (可选) 为手动触发添加输入参数
    # 你可以在 Actions 页面运行时填写这些参数
    inputs:
      log_level:
        description: 'Gradle log level'
        required: true
        default: 'info' # 默认日志级别
        type: choice
        options:
          - info
          - debug

jobs:
  # Job ID，可以自定义
  build-android-app:
    # Job 名称，会显示在 GitHub UI 中
    name: Build Android Application with Go AAR

    # 运行此 Job 的虚拟机环境
    runs-on: ubuntu-latest

    # Job 的执行步骤
    steps:
      # 步骤 1: 检出当前仓库代码 (Android App)
      - name: Checkout main Android App repository
        uses: actions/checkout@v4
        with:
          path: main-repo # 检出到名为 main-repo 的子目录

      # 步骤 2: 设置 Java 环境
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      # --- Go AAR 编译相关步骤 ---

      # 步骤 3: 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25' # 修正：与 Go 核心库的 go.mod 保持一致

      # 步骤 4: 设置 Android SDK 和 NDK
      - name: Setup Android SDK & NDK
        run: |
          export ANDROID_HOME=/usr/local/lib/android/sdk
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          
          yes | sdkmanager "ndk;25.2.9519653" "platform-tools" "build-tools;34.0.0"
          
          export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

      # 步骤 5: 安装 gomobile tools
      - name: Install gomobile tools
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      # 步骤 6: 初始化 gomobile 环境
      - name: Initialize gomobile
        run: gomobile init
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # 步骤 7: 检出 Go 核心库仓库并准备其结构
      - name: Checkout Go core library and prepare structure
        run: |
          # 检出外部 Go 核心库仓库到主仓库内的 go-core-lib 目录
          git clone https://github.com/xf22001/probe_web.git main-repo/go-core-lib
          
          # 切换到 Go 核心库的根目录进行操作
          cd main-repo/go-core-lib
          
          echo "Contents of main-repo/go-core-lib after setup:"
          ls -F .
          ls -F server/
          ls -F lib/
          ls -F static/ # 确认 static 目录存在

      # 步骤 8: 配置 Go 核心库模块并下载依赖
      - name: Configure Go core library module and download dependencies
        working-directory: ./main-repo/go-core-lib # 在 Go 核心库目录下执行
        run: |
          if [ ! -f go.mod ]; then
            go mod init probetool 
          fi
          go get golang.org/x/mobile/bind
          go mod tidy 
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # 步骤 9: 编译 Go AAR
      - name: Build Go AAR
        working-directory: ./main-repo/go-core-lib # 在 Go 核心库目录下执行
        run: |
          gomobile bind -target=android -androidapi 24 -o probetool.aar -javapkg "com.xiaofei.probetool" probetool/server
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # 步骤 10: 拷贝生成的 AAR 到 Android 应用的 libs 目录
      - name: Copy AAR to Android app libs
        working-directory: ./main-repo # 在主仓库目录下执行
        run: |
          mkdir -p ./app/libs
          cp ./go-core-lib/probetool.aar ./app/libs/probetool.aar

      # 步骤 11: 拷贝 Go 核心库的 static 文件夹到 Android 应用的 assets 目录
      - name: Copy Go core library static assets to Android app assets
        working-directory: ./main-repo # 在主仓库目录下执行
        run: |
          mkdir -p ./app/src/main/assets # 确保目标目录存在
          # 拷贝 static 文件夹的所有内容，包括子目录和文件
          cp -R ./go-core-lib/static/* ./app/src/main/assets/
          echo "Copied static assets from go-core-lib to app/src/main/assets."
          echo "Contents of app/src/main/assets:"
          ls -l ./app/src/main/assets/

      # 步骤 12: 上传生成的 probetool.aar 作为 artifact
      - name: Upload Go AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: probetool-aar
          path: ./main-repo/go-core-lib/probetool.aar
          retention-days: 7

      # --- Android APK 编译相关步骤 ---

      # 步骤 13: 授予 gradlew 执行权限
      - name: Grant execute permission for gradlew
        working-directory: ./main-repo
        run: chmod +x ./gradlew

      # 步骤 14: 解码 Keystore 并设置签名环境变量
      - name: Decode Keystore and Set Signing Environment Variables
        if: ${{ secrets.ANDROID_SIGNING_COMBINED_SECRET }}
        working-directory: ./main-repo
        run: |
          SIGNING_INFO="${{ secrets.ANDROID_SIGNING_COMBINED_SECRET }}"
          KEYSTORE_BASE64=$(echo "$SIGNING_INFO" | cut -d'|' -f1)
          KEYSTORE_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f2)
          KEY_ALIAS=$(echo "$SIGNING_INFO" | cut -d'|' -f3)
          KEY_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f4)
          
          if [ -z "$KEYSTORE_BASE64" ] || [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
            echo "Error: Failed to parse ANDROID_SIGNING_COMBINED_SECRET. One or more parts are empty."
            exit 1
          fi
          
          echo "$KEYSTORE_BASE64" | base64 --decode > app/release.jks

          echo "SIGNING_KEYSTORE_FILE=$(pwd)/app/release.jks" >> $GITHUB_ENV
          echo "SIGNING_KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
          echo "SIGNING_KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
        shell: bash
        
      # 步骤 15: 运行 Gradle 构建，生成 debug APK
      - name: Build debug APK with Gradle
        working-directory: ./main-repo
        run: ./gradlew assembleDebug --${{ github.event.inputs.log_level }}

      # 步骤 16: 上传构建产物 (Debug APK)
      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: ./main-repo/app/build/outputs/apk/debug/*.apk
          retention-days: 7

      # 步骤 17: 运行 Gradle 构建，生成 release APK
      - name: Build release APK with Gradle
        working-directory: ./main-repo
        if: ${{ secrets.ANDROID_SIGNING_COMBINED_SECRET }}
        run: ./gradlew assembleRelease --${{ inputs.log_level }}

      # 步骤 18: 上传构建产物 (Release APK)
      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ./main-repo/app/build/outputs/apk/release/*.apk
          retention-days: 7
