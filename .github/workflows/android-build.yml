name: Manual Android CI Build with Go AAR

on:
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Gradle log level'
        required: true
        default: 'info'
        type: choice
        options:
          - info
          - debug

jobs:
  build-android-app:
    name: Build Android Application with Go AAR
    runs-on: ubuntu-latest

    steps:
      # ---- STEP 1: Check out repository ----
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---- STEP 2: Set up Java ----
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # ---- STEP 3: Set up Go environment ----
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # ---- STEP 4: Setup Android SDK + cmdline-tools + NDK ----
      - name: Install Android SDK / cmdline-tools / NDK
        run: |
          export ANDROID_HOME=/usr/local/lib/android
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH

          # Install required cmdline-tools
          sudo mkdir -p $ANDROID_HOME/cmdline-tools
          sudo mv $ANDROID_HOME/cmdline-tools* $ANDROID_HOME/cmdline-tools/latest

          # Accept licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

          # Install required packages
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "ndk;25.2.9519653"

          # Export NDK path
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      # ---- STEP 5: Install gomobile ----
      - name: Install gomobile tools
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      # ---- STEP 6: gomobile init ----
      - name: Initialize gomobile
        run: gomobile init
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # ---- STEP 7: Build Go AAR ----
      - name: Build Go AAR
        working-directory: ./lib
        run: |
          if [ ! -f go.mod ]; then
            go mod init com.xiaofei.probetool.lib
          fi

          go get golang.org/x/mobile/bind

          gomobile bind -target=android \
            -androidapi 24 \
            -javapkg=com.xiaofei.probetool.lib \
            -o main.aar .
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # ---- STEP 8: Copy AAR to Android libs ----
      - name: Copy AAR into app/libs
        run: |
          mkdir -p ./app/libs
          cp ./lib/main.aar ./app/libs/main.aar

      # ---- STEP 9: Upload AAR artifact ----
      - name: Upload Go AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-aar
          path: ./lib/main.aar
          retention-days: 7

      # ---- STEP 10: Make gradlew executable ----
      - name: Grant execute permission
        run: chmod +x ./gradlew

      # ---- STEP 11: Decode keystore (if provided) ----
      - name: Decode keystore & export env
        if: ${{ secrets.ANDROID_SIGNING_COMBINED_SECRET != '' }}
        run: |
          SIGNING_INFO="${{ secrets.ANDROID_SIGNING_COMBINED_SECRET }}"
          KEYSTORE_BASE64=$(echo "$SIGNING_INFO" | cut -d'|' -f1)
          KEYSTORE_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f2)
          KEY_ALIAS=$(echo "$SIGNING_INFO" | cut -d'|' -f3)
          KEY_PASSWORD=$(echo "$SIGNING_INFO" | cut -d'|' -f4)

          echo "$KEYSTORE_BASE64" | base64 --decode > app/release.jks

          echo "SIGNING_KEYSTORE_FILE=$(pwd)/app/release.jks" >> $GITHUB_ENV
          echo "SIGNING_KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
          echo "SIGNING_KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV

      # ---- STEP 12: Build Debug APK ----
      - name: Build Debug APK
        run: ./gradlew assembleDebug --${{ inputs.log_level }}

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7

      # ---- STEP 13: Build Release APK (if keystore exists) ----
      - name: Build Release APK
        if: ${{ env.SIGNING_KEYSTORE_FILE != '' }}
        run: ./gradlew assembleRelease --${{ inputs.log_level }}

      - name: Upload Release APK
        if: ${{ env.SIGNING_KEYSTORE_FILE != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 7
